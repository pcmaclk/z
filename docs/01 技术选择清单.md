很好，这一步其实是**“冻结方向”**，非常关键。
我会把你**现在已经反复确认的取舍**整理成一份 **可执行、可落地、不过度超前** 的《技术选择清单（冻结版）》。

我会遵循三个原则：

1. **不引入你明确拒绝的复杂性**
2. **每一项都有“为什么”**
3. **允许未来升级，但不为未来背债**

---

# 技术选择清单（冻结版）

> 定位：
> **轻量 · 精致 · 大文件友好 · 单文件发布 · 非专业代码编辑器**
> 对标精神：**Notepad2 / Scintilla（而不是 VS Code / Helix）**

---

## 一、整体架构取向（已冻结）

### ✅ 架构风格

* **核心编辑器 ≠ UI**
* **数据流单向**
* **Viewport 驱动渲染**

```
Input → Action → Editor Core → Transaction
     → Viewport → ViewModel → Render Adapter
```

> Slint 只负责：**窗口 + 渲染 + 事件捕获**

---

## 二、UI / 窗口 / 渲染层

### ✅ UI 框架

**Slint（作为壳 + 渲染后端）**

#### 使用范围（严格限定）

* 窗口管理
* 文件对话框
* 菜单 / 状态栏
* 文本绘制（你控制内容）
* 虚拟化可见行渲染（50–100 行）

#### 明确不做

* ❌ 不用 Slint 的 TextEdit 做全文编辑
* ❌ 不绑定全文字符串
* ❌ 不依赖 Slint 状态管理作为编辑状态

> **Slint = GPU 加速画布 + UI 壳**

---

### 📦 可执行文件体积控制

* 渲染后端：`skia` 或 `femtovg`
* 关闭未用特性
* 单 exe 发布（语言资源内嵌）

**目标体积（Release）：**

* Windows：≈ 3–6 MB（合理）
* Linux：≈ 4–7 MB

👉 在你的需求下 **Slint 是 OK 的**

---

## 三、文本模型（核心冻结项）

### ✅ Buffer 数据结构

### **Piece Table（主方案）**

#### 结构

* Original Buffer（mmap / readonly）
* Add Buffer（append-only）
* Piece Table（Vec / Rope-like list）
* Line Index Cache（行 → offset）

#### 选择理由（与你需求 100% 对齐）

* ✅ 大文件友好（10MB+）
* ✅ 不复制原文
* ✅ 快速打开
* ✅ Undo/Redo 天然
* ✅ Viewport 虚拟化极友好
* ✅ 内存稳定

---

### ❌ 不选 Rope 作为主 buffer

Rope **不适合你当前目标**，原因：

* 常数大
* 更适合语义分析 / tree-sitter
* 不利于“只读浏览 + 局部编辑”

> Rope 可以 **保留为未来实验 / 支线**，但**不是主线**

---

## 四、Undo / Redo 系统

### ✅ Edit Transaction System（必须独立）

* 原子编辑
* 连续输入自动合并
* 撤销深度：可配置（默认 100）

#### 与 Piece Table 强绑定

* 插入：AddBuffer + Piece
* 删除：Piece 分裂
* 撤销：反向 piece 操作

👉 这是 Scintilla 稳定性的核心来源之一

---

## 五、大文件支持（明确冻结）

### ✅ 大文件策略

#### 读取

* mmap / 分段读取
* 不一次性 load 全文

#### 渲染

* 只构建：

  * 可见行
  * 上下 buffer 行（± N 行）

#### 查找

* 后台线程
* 分段扫描
* 可中断

#### 编辑限制

* 超大文件（>50MB）：

  * 可进入“受限模式”
  * 禁用部分高级功能（语法高亮等）

---

## 六、布局 / 文本绘制

### ✅ Layout System（你自己控制）

* 行切分
* tab 展开
* 字符宽度缓存
* 光标 → 像素坐标

### 📚 字体 / shaping

#### 推荐组合

* `cosmic-text`（文本 shaping / glyph）
* `fontdb`（字体管理）

#### 使用方式

* 只在 Layout 阶段用
* 输出 glyph + position
* Slint 只负责 draw

---

## 七、语法高亮（克制版）

### ✅ 自定义 lexer（不是 tree-sitter）

* 正则 / 状态机
* 行级增量高亮
* 延迟更新（idle 时）

#### 支持范围

* Plain text
* C / C++
* Python
* Markdown（基础）

👉 不追求 100% 准确，追求 **稳定 + 快**

---

## 八、折叠 / 多标签（后期）

### 📌 多标签页（必须，但低优先）

* v0.3+
* 一个 tab = 一个 Editor Core 实例
* Slint 自定义 TabBar

---

### 📌 代码折叠（简化版）

* 基于：

  * 缩进
  * `{}` / `begin-end`
* 不做 AST
* 折叠单位 = 行范围

---

## 九、国际化（冻结策略）

### ✅ 内置中 / 英

* 编译期内嵌
* 无外部语言文件
* 单文件发布

---

## 十、明确不做（边界声明）

这是你这个项目**“干净”的关键**：

* ❌ tree-sitter
* ❌ 插件系统
* ❌ 侧边栏 / TreeView
* ❌ 动画
* ❌ 代码智能补全
* ❌ LSP
* ❌ Web 技术栈

---
