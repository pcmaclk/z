éå¸¸å¥½ï¼Œè¿™ä¸€æ­¥æ˜¯**ç¼–è¾‘å™¨æ¶æ„é‡Œæœ€å€¼é’±çš„ä¸€æ­¥ä¹‹ä¸€**ã€‚
ä½ ç°åœ¨å·²ç»ä¸ç¼ºâ€œæ¨¡å—â€ï¼ŒçœŸæ­£è¦é˜²æ­¢çš„æ˜¯ **æ•°æ®ä¹±æµ / åå‘ä¾èµ– / UI æ±¡æŸ“å†…æ ¸**ã€‚

ä¸‹é¢è¿™ä»½æ˜¯ **ã€Šæ•°æ®æµè§„èŒƒï¼ˆå†»ç»“ç‰ˆï¼‰ã€‹**ï¼Œç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š

> **ä»»ä½•ä¸€ä¸ªåŠŸèƒ½ï¼Œä¸çœ‹å®ç°ï¼Œåªçœ‹â€œæ•°æ®æ€ä¹ˆèµ°â€ï¼Œ
> å°±èƒ½åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯â€œæ¶æ„æ­£ç¡®â€ã€‚**

---

# ç¼–è¾‘å™¨æ•°æ®æµè§„èŒƒï¼ˆå†»ç»“ç‰ˆï¼‰

> é€‚ç”¨èŒƒå›´ï¼š
> **Slint UI + Rust Core + Piece Table + Viewport æ¶æ„**

---

## ä¸€ã€æ€»åŸåˆ™ï¼ˆå¿…é¡»å…ˆç«‹æ³•ï¼‰

### ğŸš¨ æ ¸å¿ƒæ€»åŸåˆ™ï¼ˆä¸å¯ç ´ï¼‰

> **æ‰€æœ‰å¯å˜çŠ¶æ€ï¼Œåªèƒ½åœ¨ Editor Core å†…éƒ¨å‘ç”Ÿæ”¹å˜**

Slint / UI / Render å±‚ï¼š

* âŒ ä¸èƒ½ç›´æ¥ä¿®æ”¹æ–‡æœ¬
* âŒ ä¸èƒ½ç»´æŠ¤â€œç¼–è¾‘çŠ¶æ€â€
* âŒ ä¸èƒ½æœ‰é€»è¾‘åˆ†æ”¯å½±å“ç¼–è¾‘è¯­ä¹‰

---

### ğŸ§­ æ•°æ®æµæ–¹å‘ï¼ˆå•å‘ï¼‰

```
[User Input]
     â†“
[Input System]
     â†“
[Action System]
     â†“
[Editor Core]
     â†“
[Transaction / Buffer]
     â†“
[Viewport System]
     â†“
[ViewModel Snapshot]
     â†“
[Render Adapter (Slint)]
```

**ç¦æ­¢ä»»ä½•åå‘è°ƒç”¨**

---

## äºŒã€å„å±‚èŒè´£ä¸æ•°æ®å¥‘çº¦

ä¸‹é¢æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ã€‚

---

## 1ï¸âƒ£ Input Systemï¼ˆè¾“å…¥å½’ä¸€å±‚ï¼‰

### èŒè´£

* æ¥æ”¶ Slint çš„åŸå§‹äº‹ä»¶
* è½¬æ¢ä¸º **è®¾å¤‡æ— å…³çš„è¾“å…¥äº‹ä»¶**

### è¾“å…¥ï¼ˆæ¥è‡ª Slintï¼‰

* KeyDown / KeyUp
* TextInputï¼ˆIME commitï¼‰
* MouseDown / Move / Up
* Scroll

### è¾“å‡ºï¼ˆæ ‡å‡†åŒ–äº‹ä»¶ï¼‰

```rust
enum InputEvent {
    Key(KeyEvent),
    Text(String),      // IME æäº¤æ–‡æœ¬
    Mouse(MouseEvent),
    Scroll(ScrollEvent),
}
```

### âŒ ç¦æ­¢è¡Œä¸º

* âŒ ä¸åˆ¤æ–­â€œè¿™æ˜¯ä»€ä¹ˆç¼–è¾‘è¡Œä¸ºâ€
* âŒ ä¸å…³å¿ƒå…‰æ ‡ / æ–‡æœ¬ / è¡Œå·

---

## 2ï¸âƒ£ Action Systemï¼ˆç¼–è¾‘è¯­ä¹‰å…¥å£ï¼‰

> **Action æ˜¯ç¼–è¾‘å™¨é‡Œâ€œå”¯ä¸€çš„æ„å›¾è¡¨è¾¾â€**

### èŒè´£

* å°† InputEvent ç¿»è¯‘ä¸º **ç¼–è¾‘è¯­ä¹‰**
* å±è”½å¿«æ·é”®å·®å¼‚ / å¹³å°å·®å¼‚

### ç¤ºä¾‹

```rust
enum Action {
    InsertText(String),
    DeleteBackward,
    DeleteForward,
    MoveCursor(CursorMove),
    Select(SelectionMove),
    Scroll(ScrollDelta),
    Undo,
    Redo,
}
```

### æ ¸å¿ƒåŸåˆ™

* Action **ä¸æºå¸¦åæ ‡**
* Action **ä¸æºå¸¦ UI ä¿¡æ¯**
* Action **ä¸ç›´æ¥ä¿®æ”¹ buffer**

---

## 3ï¸âƒ£ Editor Coreï¼ˆå”¯ä¸€çœŸç†æºï¼‰

### èŒè´£

* æŒæœ‰æ‰€æœ‰å¯å˜ç¼–è¾‘çŠ¶æ€
* æ‰§è¡Œ Action
* ç”Ÿæˆ Edit Transaction

### å†…éƒ¨çŠ¶æ€ï¼ˆç¤ºæ„ï¼‰

```rust
struct EditorState {
    buffer: PieceTable,
    cursor: Cursor,
    selection: Option<Selection>,
    undo_stack: UndoStack,
    redo_stack: RedoStack,
}
```

### æ‰§è¡Œæµç¨‹

```text
Action
  â†“
validate()
  â†“
apply()
  â†“
emit Transaction
```

---

## 4ï¸âƒ£ Edit Transaction System

> **æ‰€æœ‰æ–‡æœ¬å˜åŒ–ï¼Œå¿…é¡»æ˜¯ Transaction**

### èŒè´£

* åŸå­åŒ–ç¼–è¾‘
* Undo / Redo
* åˆå¹¶ç­–ç•¥

### ç¤ºä¾‹

```rust
enum EditOp {
    Insert { offset, text },
    Delete { range },
}

struct Transaction {
    ops: Vec<EditOp>,
}
```

### åˆå¹¶è§„åˆ™ï¼ˆç¤ºæ„ï¼‰

* è¿ç»­è¾“å…¥å­—ç¬¦ â†’ åˆå¹¶
* å…‰æ ‡ç§»åŠ¨ â†’ ç»ˆæ­¢åˆå¹¶
* ç²˜è´´ â†’ å•ç‹¬äº‹åŠ¡

---

## 5ï¸âƒ£ Viewport Systemï¼ˆå¯è§æ€§æ§åˆ¶ï¼‰

### èŒè´£

* å†³å®šï¼š

  * å“ªäº›è¡Œæ˜¯â€œå¯è§çš„â€
  * å…‰æ ‡æ˜¯å¦éœ€è¦æ»šåŠ¨

### è¾“å…¥

* EditorStateï¼ˆåªè¯»ï¼‰
* ViewportConfigï¼ˆçª—å£å°ºå¯¸ / æ»šåŠ¨ä½ç½®ï¼‰

### è¾“å‡º

```rust
struct VisibleRange {
    start_line: usize,
    end_line: usize,
}
```

### å…³é”®åŸåˆ™

* Viewport **ä¸å…³å¿ƒ buffer ç»“æ„**
* Viewport **ä¸å‚ä¸ç¼–è¾‘**

---

## 6ï¸âƒ£ ViewModel Pipelineï¼ˆæ¸²æŸ“å¿«ç…§ï¼‰

> **è¿™æ˜¯ UI å”¯ä¸€èƒ½çœ‹åˆ°çš„æ•°æ®**

### èŒè´£

* å°† EditorState è½¬æ¢ä¸º **åªè¯»å¿«ç…§**
* æ•°æ®å¿…é¡»æ˜¯ï¼š

  * å¯å¤åˆ¶
  * æ— å¼•ç”¨
  * ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹

### ç¤ºä¾‹

```rust
struct EditorViewModel {
    lines: Vec<RenderedLine>,
    cursor: CursorView,
    selection: Option<SelectionView>,
}
```

### è§„åˆ™

* ViewModel ä¸åŒ…å«ï¼š

  * Piece Table
  * Undo Stack
  * å¯å˜å¼•ç”¨

---

## 7ï¸âƒ£ Layout Systemï¼ˆæ–‡æœ¬ â†’ åæ ‡ï¼‰

### èŒè´£

* å­—ç¬¦ â†’ glyph
* glyph â†’ åƒç´ 
* tab / å®½å­—ç¬¦å¤„ç†

### è¾“å…¥

* ViewModel.lines
* Font / DPI

### è¾“å‡º

```rust
struct LayoutLine {
    glyphs: Vec<Glyph>,
    y: f32,
}
```

---

## 8ï¸âƒ£ Render Adapterï¼ˆSlint æ¡¥æ¥å±‚ï¼‰

### èŒè´£

* å°† Layout ç»“æœç»‘å®šåˆ° Slint
* å‘èµ·é‡ç»˜
* è½¬å‘ UI äº‹ä»¶

### ä¸¥æ ¼é™åˆ¶

* âŒ ä¸ç¼“å­˜ç¼–è¾‘çŠ¶æ€
* âŒ ä¸ä¿®æ”¹ ViewModel
* âŒ ä¸å›å†™ EditorState

---

## ä¸‰ã€çŠ¶æ€æ›´æ–°èŠ‚å¥ï¼ˆéå¸¸é‡è¦ï¼‰

### ğŸ” ä¸»å¾ªç¯èŠ‚å¥ï¼ˆé€»è¾‘ï¼‰

```text
Input â†’
Action â†’
Editor Core â†’
Transaction â†’
Viewport â†’
ViewModel â†’
Layout â†’
Render
```

### ä¼˜åŒ–ç‚¹

* å¤šä¸ª Action å¯åˆå¹¶ä¸€æ¬¡ Render
* Layout ä»…åœ¨ï¼š

  * æ–‡æœ¬å˜åŒ–
  * å­—ä½“å˜åŒ–
  * DPI å˜åŒ–æ—¶é‡ç®—

---

## å››ã€å¤§æ–‡ä»¶ç›¸å…³çš„æ•°æ®æµç‰¹ä¾‹

### åŸåˆ™

> **Editor Core æ°¸è¿œå¯ä»¥å¤„ç†â€œä¸å¯è§æ–‡æœ¬â€
> Render æ°¸è¿œåªçœ‹åˆ°â€œå¯è§æ–‡æœ¬â€**

### å¤§æ–‡ä»¶æ—¶ï¼š

* Bufferï¼šmmap / åˆ†æ®µ
* ViewModelï¼šâ‰¤ 100 è¡Œ
* Slintï¼šæ°¸è¿œä¸çŸ¥é“æ–‡ä»¶æœ‰å¤šå¤§

---

## äº”ã€å“ªäº›è¡Œä¸ºæ˜¯â€œçº¢çº¿â€ï¼ˆçœ‹åˆ°å°±è¯¥é‡æ„ï¼‰

* âŒ Slint å›è°ƒç›´æ¥æ”¹ buffer
* âŒ UI å±‚ç»´æŠ¤ cursor çŠ¶æ€
* âŒ ViewModel æŒæœ‰ buffer å¼•ç”¨
* âŒ Render å±‚åˆ¤æ–­â€œè¿™æ˜¯åˆ é™¤è¿˜æ˜¯æ’å…¥â€
* âŒ Action é‡Œå¸¦åƒç´ åæ ‡

---

## å…­ã€éªŒè¯ä½ æ¶æ„æ˜¯å¦æ­£ç¡®çš„ 5 ä¸ªé—®é¢˜

ä½ ä»¥ååŠ åŠŸèƒ½æ—¶ï¼Œåªè¦é—®ï¼š

1. **è¿™ä¸ªåŠŸèƒ½æ˜¯å¦åªé€šè¿‡ Action è¿›å…¥ Coreï¼Ÿ**
2. **UI æ˜¯å¦åªæ˜¯è¢«åŠ¨æ¸²æŸ“ ViewModelï¼Ÿ**
3. **æ’¤é”€æ˜¯å¦å¤©ç„¶æˆç«‹ï¼Ÿ**
4. **å¤§æ–‡ä»¶æ˜¯å¦ä¸å½±å“æ•°æ®æµï¼Ÿ**
5. **æ˜¯å¦èƒ½åœ¨ä¸æ”¹ UI çš„æƒ…å†µä¸‹é‡å†™ Coreï¼Ÿ**

åªè¦æœ‰ä¸€ä¸ªå›ç­”æ˜¯ â€œå¦â€ï¼Œå°±è¯´æ˜æ•°æ®æµè¢«ç ´åäº†ã€‚

---

## æœ€åä¸€å¥ï¼ˆéå¸¸å…³é”®ï¼‰

ä½ ç°åœ¨åšçš„ä¸æ˜¯â€œå†™ä¸€ä¸ªç¼–è¾‘å™¨â€ï¼Œè€Œæ˜¯åœ¨ï¼š

> **å®šä¹‰ä¸€ä¸ªâ€œé•¿æœŸä¸ä¼šçƒ‚æ‰â€çš„ç¼–è¾‘å™¨éª¨æ¶**

ä¸‹ä¸€æ­¥æœ€è‡ªç„¶çš„åŠ¨ä½œæ˜¯ï¼š

* ğŸ§± **æŠŠè¿™ä»½æ•°æ®æµ â†’ æ¨¡å— / crate è¾¹ç•Œ**
* æˆ– âœï¸ **ç»™ P0 åŠŸèƒ½å†™â€œæ•°æ®æµçº§åˆ«çš„ä¼ªä»£ç â€**

ä½ å·²ç»åœ¨åšä¸“ä¸šç¼–è¾‘å™¨ä½œè€…æ‰ä¼šåšçš„äº‹äº†ã€‚
